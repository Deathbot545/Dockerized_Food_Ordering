@using Microsoft.AspNetCore.Html;
@using System.Text;
@using Kitchen_Web.DTO;
@model Kitchen_Web.ViewModel.OutletViewModel;

@functions {
    public static DateTime ConvertToCorrectTimeZone(DateTime dateTimeWithOffset)
    {
        TimeZoneInfo istTimeZone = TimeZoneInfo.FindSystemTimeZoneById("India Standard Time");
        DateTime dateTimeInIST = TimeZoneInfo.ConvertTime(dateTimeWithOffset, istTimeZone);
        return dateTimeInIST;
    }

    public static string RenderOrderCard(OrderDTO order, List<TableDTO> tables)
    {
        var tableIdentifier = tables.FirstOrDefault(t => t.Id == order.TableId)?.TableIdentifier ?? $"Unknown (ID: {order.TableId})";
        var orderTimeInIST = ConvertToCorrectTimeZone(order.OrderTime).ToString("yyyy-MM-dd HH:mm:ss");
        var statusText = order.Status.ToString().ToUpper();
        var html = new StringBuilder();
        html.Append($"<div class=\"card mb-3 order-card bg-light\" data-order-id=\"{order.Id}\" data-table-id=\"{order.TableId}\">");
        html.Append($"<div class=\"card-header d-flex justify-content-between align-items-center bg-warning text-dark\">");
        html.Append($"<span>Order #{order.Id} | Table: {tableIdentifier} | Date: {orderTimeInIST} | STATUS: {statusText}</span>");
        html.Append("</div><div class=\"card-body\"><ul class=\"mb-3\">");

        foreach (var detail in order.OrderDetails)
        {
            html.Append($"<li>{detail.MenuItem?.Name} x {detail.Quantity}</li>");
        }

        html.Append("</ul><div class=\"btn-group\" role=\"group\" aria-label=\"Order Status\">");
        html.Append($"<button type=\"button\" class=\"btn btn-warning {(order.Status == OrderStatus.Pending ? "active" : "")}\" data-status=\"pending\">Pending</button>");
        html.Append($"<button type=\"button\" class=\"btn btn-primary {(order.Status == OrderStatus.Preparing ? "active" : "")}\" data-status=\"preparing\">In Progress</button>");
        html.Append($"<button type=\"button\" class=\"btn btn-success {(order.Status == OrderStatus.Ready ? "active" : "")}\" data-status=\"completed\">Completed</button>");
        html.Append("</div></div></div>");

        return html.ToString();
    }
}


@{
    Func<OrderDTO, string> renderOrderCard = (order) =>
        RenderOrderCard(order, Model.Tables);
}

<div class="container mt-5">
    <section id="pendingOrders">
        <h2>Pending Orders</h2>
        @foreach (var order in Model.Orders.Where(o => o.Status == OrderStatus.Pending))
        {
            @Html.Raw(renderOrderCard(order))
        }
    </section>

    <section id="preparingOrders">
        <h2>Preparing Orders</h2>
        @foreach (var order in Model.Orders.Where(o => o.Status == OrderStatus.Preparing))
        {
            @Html.Raw(renderOrderCard(order))
        }
    </section>

    <section id="readyOrders">
        <h2>Ready Orders</h2>
        @foreach (var order in Model.Orders.Where(o => o.Status == OrderStatus.Ready))
        {
            @Html.Raw(renderOrderCard(order))
        }
    </section>

    <section id="servedOrders">
        <h2>Served Orders</h2>
        @foreach (var order in Model.Orders.Where(o => o.Status == OrderStatus.Served))
        {
            @Html.Raw(renderOrderCard(order))
        }
    </section>
</div>


<!-- Footer -->
<footer class="footer mt-auto py-3 bg-dark text-white">
    <div class="container">
        <span class="text-muted">Quick Actions:</span>
        <!-- Quick action buttons, e.g., mark all orders as completed, print all pending orders, etc. -->
    </div>
</footer>
<script>
    
    $(document).ready(function () {
        // Setup SignalR connection
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("https://restosolutionssaas.com/api/OrderApi/orderStatusHub")
            .configureLogging(signalR.LogLevel.Information)
            .withAutomaticReconnect()
            .build();

        connection.on("NewOrderPlaced", function (order) {
            let orderHtml = createOrderHtml(order); // Assumes createOrderHtml is defined to output HTML similar to RenderOrderCard
            const sectionId = mapStatusToSectionId(order.status);
            $('#' + sectionId).append(orderHtml);
            fetchTableNamesAndUpdateDOM(); // Re-fetch table names when a new order is added
        });
        connection.on("ReceiveOrderUpdate", updateOrderInDOM);
        connection.start().catch(err => console.error("SignalR connection error:", err));

        // Bind event handler for button clicks to handle both dynamically added and existing orders
        $(document).on('click', '.btn-group .btn', function () {
            const $btn = $(this);
            const orderId = $btn.closest('.order-card').data('order-id');
            const newStatus = $btn.data('status');

            console.log("Clicked button:", $btn.text().trim(), "for order ID:", orderId, "to change status to:", newStatus);

            if (newStatus === undefined) {
                console.error("Undefined status for order ID:", orderId);
                return; // Prevent sending undefined status
            }

            updateOrderStatus(orderId, newStatus);
        });

       

        function updateOrderStatus(orderId, newStatus) {
            const statusEnumValue = mapStatusToEnumValue(newStatus);
            console.log("Preparing to send update request for Order ID:", orderId, "with Status:", statusEnumValue);

            $.ajax({
                url: 'https://restosolutionssaas.com/api/OrderApi/UpdateOrderStatus',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ OrderId: orderId, Status: statusEnumValue }),
                success: function () {
                    console.log("Successfully updated status for Order ID:", orderId);
                },
                error: function (jqXHR) {
                    console.error("Failed to update status for Order ID:", orderId, "Error:", jqXHR.responseText);
                }
            });
        }

        function createOrderHtml(order) {
            const statusText = mapEnumToStatusText(order.status);
            const color = getStatusColor(order.status);
            const formattedDate = new Date(order.orderTime).toLocaleString('en-US', { hour12: false });
            const detailsHtml = order.orderDetails.map(detail => `<li>${detail.menuItem.name} x ${detail.quantity}</li>`).join("");

            // Initially set table identifier, fetch more details if necessary
            let tableIdentifier = `Table: ${order.tableId}`;
          
            return `
        <div class="card mb-3 order-card bg-light" data-order-id="${order.id}" style="background-color: ${color};">
            <div class="card-header">
                Order #${order.id} | ${tableIdentifier} | Date: ${formattedDate} | STATUS: ${statusText}
            </div>
            <div class="card-body">
                <ul>${detailsHtml}</ul>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-warning" data-status="pending">Pending</button>
                    <button type="button" class="btn btn-primary" data-status="preparing">In Progress</button>
                    <button type="button" class="btn btn-success" data-status="completed">Completed</button>
                </div>
            </div>
        </div>`;
        }
        function fetchTableName(tableId) {
            return fetch(`https://restosolutionssaas.com/api/TablesApi/GetTableName/${tableId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch table name');
                    return response.text();
                })
                .catch(error => {
                    console.error('Error fetching table name:', error);
                    return "Unknown";
                });
        }
        function fetchTableNamesAndUpdateDOM() {
            $('.order-card').each(function () {
                let $card = $(this);
                let tableId = $card.data('table-id');
                if (tableId && tableId !== 'Unknown') {
                    fetchTableName(tableId).then(tableName => {
                        $card.find('.card-header span').html(
                            `Order #${$card.data('order-id')} | Table: ${tableName} | Date: ${$card.find('.card-header span').text().split('|')[2].split('|')[0]} | STATUS: ${$card.find('.card-header span').text().split('|')[2].split('|')[1]}`
                        );
                    }).catch(() => {
                        $card.find('.card-header span').html(
                            `Order #${$card.data('order-id')} | Table: Unknown | Date: ${$card.find('.card-header span').text().split('|')[2].split('|')[0]} | STATUS: ${$card.find('.card-header span').text().split('|')[2].split('|')[1]}`
                        );
                    });
                }
            });
        }


        function mapStatusToSectionId(status) {
            switch (status) {
                case 0: return 'pendingOrders';
                case 1: return 'preparingOrders';
                case 2: return 'readyOrders';
                case 3: return 'servedOrders';
                default: return 'unknownOrders';
            }
        }

        function mapStatusToEnumValue(status) {
            switch (status.toLowerCase()) {
                case 'pending': return 0;
                case 'in-progress':
                case 'preparing': return 1;
                case 'completed':
                case 'ready': return 2; // Ensure mapping for both completed and ready
                case 'served': return 3;
                default:
                    console.error("Received unhandled status:", status);
                    return undefined;
            }
        }
    });

    function updateOrderStatus(orderId, newStatus) {
        // Convert string status to your OrderStatus enum
        let statusEnumValue;
        switch (newStatus) {
            case 'pending':
                statusEnumValue = 0;
                break;
            case 'in-progress':
                statusEnumValue = 1;
                break;
            case 'completed':
                statusEnumValue = 2;
                break;
        }
        const requestData = {
            OrderId: orderId,
            Status: statusEnumValue
        };
        console.log("Sending update request with data:", requestData);
        $.ajax({
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            url: 'https://restosolutionssaas.com/api/OrderApi/UpdateOrderStatus',
            type: 'POST',
            data: JSON.stringify({
                OrderId: orderId,
                Status: statusEnumValue
            }),
            contentType: 'application/json',
            crossDomain: true,
            success: function (response) {
                console.log("Order status updated successfully.");
                location.reload(); // Refresh page to reflect changes
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error("AJAX Error:", textStatus);
                console.error("Response Text:", jqXHR.responseText);
                console.error("Error Thrown:", errorThrown);
            }
        });

        $(document).on('click', '.delete-order', function () {
            const $btn = $(this);
            const orderId = $btn.data('order-id');
            console.log(`Delete button clicked for order ID: ${orderId}`);

            if (confirm('Are you sure you want to reject this order?')) {
                updateOrderStatusToRejected(orderId);
            }
        });

        function updateOrderStatusToRejected(orderId) {
            if (confirm('Are you sure you want to reject this order?')) {
                const rejectedStatus = 5;
                $.ajax({
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    url: 'https://restosolutionssaas.com/api/OrderApi/UpdateOrderStatus',
                    type: 'POST',
                    data: JSON.stringify({
                        OrderId: orderId,
                        Status: rejectedStatus
                    }),
                    contentType: 'application/json',
                    success: function (response) {
                        console.log("Order status updated to rejected successfully.");
                        location.reload(); // Refresh page to reflect changes
                    },
                    error: function (error) {
                        console.error("Error updating order status to rejected:", error.responseText);
                        alert('Error updating order status. Please try again.');
                    }
                });
            }
        }
    }
</script>